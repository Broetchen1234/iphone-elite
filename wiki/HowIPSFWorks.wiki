#summary How iPhoneSIMFree works.
#labels Featured,IPSF,Phase-QA

=How IPSF works=
_This was originally posted, then deleted, from The iPhone Dev Wiki...as spam._

==The following things were observed by Zibri and/or others:==
- IPSF does not make a patch or otherwise change things in baseband firmware, except temporarily to put their unlock patch in the NVRAM.

- When their application is run a small chunk of NVRAM is extracted from the device and uploaded to the IPSF server.  This packet is sent to backoffice.iphonesimfree.com.

- The packet is sent back after being modified where the LOCK is saved.

- A custom baseband bootblock is used to flash the 'unlock' patch to NVRAM.

- Then they overwrite the baseband with the original firmware again.

== The following is the main thread in the IPSF software ==
{{{
0000D8F4 MAIN_LOOP                               ; CODE XREF: DO_THINGS+50j
0000D8F4                                         ; DO_THINGS+A0j
0000D8F4                 LDR     R3, [SP,#0xA0+var_C]
0000D8F8                 LDR     R3, [R3,#0x1C]
0000D8FC                 CMP     R3, #3
0000D900                 BEQ     Prepare_UNLOCK
0000D904                 LDR     R3, [SP,#0xA0+var_C]
0000D908                 LDR     R3, [R3,#0x1C]
0000D90C                 CMP     R3, #4
0000D910                 BEQ     Create_Fingerprint
0000D914                 LDR     R3, [SP,#0xA0+var_C]
0000D918                 LDR     R3, [R3,#0x1C]
0000D91C                 CMP     R3, #5
0000D920                 BEQ     Comunicate_Server
0000D924                 LDR     R3, [SP,#0xA0+var_C]
0000D928                 LDR     R3, [R3,#0x1C]
0000D92C                 CMP     R3, #6
0000D930                 BEQ     Unlock___
0000D934                 LDR     R3, [SP,#0xA0+var_C]
0000D938                 LDR     R3, [R3,#0x1C]
0000D93C                 CMP     R3, #7
0000D940                 BEQ     Cleanup___
0000D944                 LDR     R3, [SP,#0xA0+var_C]
0000D948                 LDR     R3, [R3,#0x1C]
0000D94C                 CMP     R3, #8
0000D950                 BNE     Success
0000D954                 MOV     R3, #9
0000D958                 LDR     R2, [SP,#0xA0+var_C]
0000D95C                 STR     R3, [R2,#0x1C]
0000D960                 LDR     R3, [SP,#0xA0+var_C]
0000D964                 LDRB    R3, [R3,#0x26]
0000D968                 CMP     R3, #1
0000D96C                 BNE     check_unlock
0000D970                 LDR     R0, [SP,#0xA0+var_C]
0000D974                 STR     R0, [SP,#0xA0+var_78]
0000D978                 LDR     R3, =do_things_0
0000D97C                 LDR     R1, [R3]
0000D980                 BL      _objc_msgSend
0000D984                 B       exit1
}}}

== Explaination: ==

|| *Prepare_UNLOCK* is the routine that flashes custom firmware to the baseband.||
|| *Create_Fingerprint* extracts a small chunk of NVRAM and creates a packet. ||
|| *Communicate_Server* sends that packet to backoffice.iphonesimfree.com and receives it back modified. ||
|| *Unlock* writes the now modified chunk back to NVRAM. ||
|| *Cleanup* removes the custom baseband firmware and replaces the original. ||

= Theories about how to perform *true* unlock =
== *Terms* ==
  *NNCK: Unlock code
  IMEI: The International Mobile Equipment Identity is a 15 digit code used to identify the GSM/DCS/PCS phone to the network. [http://www.google.com/url?sa=X&start=2&oi=define&q=http://www.cellular.co.za/cellularterms.htm&usg=AFQjCNERkKPued5T9F3b1dq4PpiMe-9_2Q source]
  Baseband: This is the GSM modem along with a few other things.  It has it's own co-processor, memory cache and operating system (Nucleus real-time OS.)

|| How a phone is normally *true* unlocked ||

  Manufacturer generates a random NCK for IMEI.
  They do hash(NCK) and store it on the phone.
  hash(NCK) is *one way*.  It is not possible to retrieve the NCK from the hash stored on the phone.
  User enters an NCK into the phone to unlock it.
  The phone then does hash(NCK) and compares it to the hash already stored.
  If they match, then you're unlocked.
  This is how NCK is verified.

*The trick is: How does the phone actually perform the unlock?*

|| *METHOD 1* ||

  Phone verifies hash(NCK) above and says "OK, I should unlock now."
  Phone then jumps to a routine that generates an unlocked NVRAM and writes it.
  User is unlocked.
  In this case it could be possible to skip the NCK verification by patching the baseband to jump directly to the unlock routine, write the unlock, then unpatch.

|| *METHOD 2* ||
  hash(NCK) is required to be put into NVRAM to trigger a successful unlock routine.
  This sounds more secure but it's not since it would indicate that the phone can do unhash(NCK) in order to validate.
  If we make up an NCK (FAKE_NCK) and do hash(FAKE_NCK) and put it into NVRAM, how does the phone know if that == locked or unlocked?
  If we know what the real hash(NCK) is, it might be possible to generate the same hash with a fake NCK.
  Something *must* be written to NVRAM to indicate unlock or not.
  The question is does that something depend on NCK?

In the NVRAM there is an encrypted simlock data section based on IMEI.  It's not just 0 = unlocked 1 = locked.  Phone A will have a different bit of data than phone B.  If the phone receives the correct NCK then it can generate the correct piece of data that indicates UNLOCKED.  In this case we should forget about writing directly to NVRAM ourselves since it will be different for each phone.  We've only to learn exactly what the _phone_ wants to write, and trigger that.

|| *QUESTIONS* ||
-- How does the phone know what to write into NVRAM? Is it based on the NCK or is the NCK irrelevant and it's just an access code to execute unlock routine?  If it's irrelevant we've only to jump the verification and execute the unlock.  Once we've triggered it we remove our baseband patch and the phone is virgin again.


_This page will be updated as discoveries are made_